<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Olympic Medal Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      .chart-container {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
      }
      #map-tooltip {
        position: absolute;
        pointer-events: auto;
        background: white;
        padding: 6px 10px;
        border: 1px solid #aaa;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      #line-tooltip {
        position: absolute;
        pointer-events: auto;
        background: white;
        padding: 6px 10px;
        border: 1px solid #aaa;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      #chart-tooltip {
        position: absolute;
        pointer-events: auto;
        background: white;
        padding: 6px 10px;
        border: 1px solid #aaa;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      #left-panel {
        width: 55%;
        border-right: 1px solid #ccc;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
      }
      #right-panel {
        flex-grow: 1;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      .section {
        margin-bottom: 20px;
      }
      .section h3 {
        margin-bottom: 10px;
      }
      .toggle-group button {
        margin-right: 10px;
      }
      #chart-line {
        display: block;
      }
      #chart-map {
        display: none;
      }
      .hidden {
        display: none;
      }
      svg {
        display: block;
        margin: 0 auto;
      }
      .year {
        text-decoration: underline;
        cursor: pointer;
        color: blue;
      }
    </style>
  </head>
  <body>
    <div id="left-panel">
      <div class="section">
        <h3>View Mode</h3>
        <div class="toggle-group">
          <button id="line-view-btn">Line Graph</button>
          <button id="map-view-btn">Map View</button>
        </div>
      </div>

      <div id="row-map">
        <div id="chart-map">
          <h2 style="margin-bottom: 4px;">Summer Olympic Host Cities (1896 - 2012)</h2>
          <i
            >Click a year on a line to update bar charts.</i
          ><br /><br />
          <div id="map"></div>
          <div id="map-tooltip"></div>
        </div>
        <div id="chart-line">
          <h2 style="margin-bottom: 4px">Medals Over Time</h2>
          <i
            >Select a country and/or sport to show more lines. Click a year on a
            line to update bar charts.</i
          >
          <br /><br />
          <label>Country:</label>
          <select id="country-select">
            <option value="none">None</option>
          </select>

          <label>&nbsp;Sport:</label>
          <select id="sport-select">
            <option value="none">None</option>
          </select>
          <svg id="line-chart" width="700" height="400"></svg>
          <div id="line-tooltip"></div>
        </div>
      </div>
    </div>

    <div id="right-panel">
      <div class="section">
        <h3>Medal Count</h3>
        <div class="toggle-group">
          <button id="by-country-btn">By Country</button>
          <button id="by-sport-btn">By Sport</button>
          <button id="by-athlete-btn">By Athlete</button>
        </div>
      </div>
      <div id="chart">
        <h2 id="chart-title">By Country - Total</h2>
        <div class="chart-container">
          <svg id="bar-chart" width="600"></svg>
        </div>
        <div id="chart-tooltip"></div>
      </div>
    </div>
    <script>
      const mapBlock = document.getElementById("chart-map");
      const lineBlock = document.getElementById("chart-line");

      document.getElementById("line-view-btn").addEventListener("click", () => {
        mapBlock.style.display = "none";
        lineBlock.style.display = "block";
      });

      document.getElementById("map-view-btn").addEventListener("click", () => {
        lineBlock.style.display = "none";
        mapBlock.style.display = "block";
      });

      const mapWidth = 700,
        mapHeight = 400;
      const chartWidth = 600;
      const margin = { top: 30, right: 20, bottom: 30, left: 50 };

      const svgMap = d3
        .select("#map")
        .append("svg")
        .attr("width", mapWidth)
        .attr("height", mapHeight);
      const mapTooltip = d3.select("#map-tooltip");
      const svgChart = d3.select("#bar-chart");
      const svgEventChart = d3.select("#event-chart");
      const svgAthleteChart = d3.select("#athlete-chart");
      const lineTooltip = d3.select("#line-tooltip");
      const barTooltip = d3.select("#chart-tooltip");

      const projection = d3
        .geoMercator()
        .scale(120)
        .center([15, 10]) // center longitude, latitude
        .translate([mapWidth / 2, mapHeight / 2]);
      const path = d3.geoPath().projection(projection);

      let selectedYear = null;
      let selectedCountry = null;
      let selectedSport = null;
      let selectedBar = "country";
      let sBarCountry = null;
      let sBarSport = null;

      Promise.all([
        d3.json(
          "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"
        ),
        d3.json("centroids.json"),
        d3.json("years.json"),
        d3.json("countries.json"),
        d3.json("events.json"),
        d3.json("athletes.json"),
      ]).then(([world, cities, years, countries, events, athletes]) => {
        const mapCountries = topojson.feature(world, world.objects.countries);

        const svgLine = d3.select("#line-chart");
        const svgChart = d3.select("#bar-chart");
        const lineMargin = { top: 30, right: 200, bottom: 40, left: 50 };
        const lineWidth =
          +svgLine.attr("width") - lineMargin.left - lineMargin.right;
        const lineHeight =
          +svgLine.attr("height") - lineMargin.top - lineMargin.bottom;

        const gLine = svgLine
          .append("g")
          .attr("transform", `translate(${lineMargin.left},${lineMargin.top})`);

        const countrySelect = d3.select("#country-select");
        const countryList = Object.keys(countries).sort();
        countryList.forEach((c) =>
          countrySelect.append("option").attr("value", c).text(c)
        );

        const sportSelect = d3.select("#sport-select");
        const sportList = Object.keys(events).sort();
        sportList.forEach((c) =>
          sportSelect.append("option").attr("value", c).text(c)
        );

        document
          .getElementById("by-sport-btn")
          .addEventListener("click", () => {
            selectedBar = "sport";
            drawBarChart(selectedBar);
          });

        document
          .getElementById("by-country-btn")
          .addEventListener("click", () => {
            selectedBar = "country";
            drawBarChart(selectedBar);
          });

        document
          .getElementById("by-athlete-btn")
          .addEventListener("click", () => {
            selectedBar = "athlete";
            drawBarChart(selectedBar);
          });

        function createYearsData(data, country, sport) {
          const result = {};

          for (const year in data) {
            const entries = data[year];
            medal_ct = 0;
            for (const item of entries) {
              const matchCountry = !country || item.country == country;
              const matchSport = !sport || item.sport == sport;

              if (matchCountry && matchSport) {
                medal_ct += item.bronze + item.silver + item.gold;
              }
            }

            if (medal_ct != 0) {
              result[year] = medal_ct;
            }
          }
          return result;
        }

        const hiddenSeries = new Set();

        function drawLineChart() {
          gLine.selectAll("*").remove();
          const series = [
            {
              name: "Overall",
              color: "forestgreen",
              data: Object.entries(createYearsData(years, null, null))
                .map(([year, total]) => ({ year: +year, total }))
                .sort((a, b) => a.year - b.year),
            },
          ];

          if (selectedCountry) {
            series.push({
              name: selectedCountry,
              color: "tomato",
              data: Object.entries(
                createYearsData(years, selectedCountry, null)
              )
                .map(([year, total]) => ({ year: +year, total }))
                .sort((a, b) => a.year - b.year),
            });
          }

          if (selectedSport) {
            series.push({
              name: selectedSport,
              color: "steelblue",
              data: Object.entries(createYearsData(years, null, selectedSport))
                .map(([year, total]) => ({ year: +year, total }))
                .sort((a, b) => a.year - b.year),
            });
          }

          if (selectedSport && selectedCountry) {
            series.push({
              name: `${selectedCountry} and ${selectedSport}`,
              color: "mediumorchid",
              data: Object.entries(
                createYearsData(years, selectedCountry, selectedSport)
              )
                .map(([year, total]) => ({ year: +year, total }))
                .sort((a, b) => a.year - b.year),
            });
          }

          const visibleSeries = series.filter((s) => !hiddenSeries.has(s.name));

          const x = d3
            .scaleLinear()
            .domain([
              d3.min(visibleSeries, (s) => d3.min(s.data, (d) => d.year)),
              d3.max(visibleSeries, (s) => d3.max(s.data, (d) => d.year)),
            ])
            .range([0, lineWidth]);

          const y = d3
            .scaleLinear()
            .domain([
              0,
              d3.max(visibleSeries, (s) => d3.max(s.data, (d) => d.total)),
            ])
            .nice()
            .range([lineHeight, 0]);

          // Axes
          gLine
            .append("g")
            .attr("transform", `translate(0,${lineHeight})`)
            .call(d3.axisBottom(x).tickFormat(d3.format("d")));

          gLine.append("g").call(d3.axisLeft(y));

          // Line generator
          const line = d3
            .line()
            .x((d) => x(d.year))
            .y((d) => y(d.total));

          // Draw each line
          visibleSeries.forEach((s) => {
            gLine
              .append("path")
              .datum(s.data)
              .attr("fill", "none")
              .attr("stroke", s.color)
              .attr("stroke-width", 2)
              .attr("d", line);

            gLine
              .selectAll(`.dot-${s.name}`)
              .data(s.data)
              .enter()
              .append("circle")
              .attr("cx", (d) => x(d.year))
              .attr("cy", (d) => y(d.total))
              .attr("r", 3)
              .attr("fill", s.color)
              .on("click", (event, d) => {
                selectedYear = d.year;
                if (s.name === selectedCountry) {
                  sBarCountry = selectedCountry;
                  sBarSport = null;
                } else if (s.name === selectedSport) {
                  sBarSport = selectedSport;
                  sBarCountry = null;
                } else if (
                  s.name === `${selectedCountry} and ${selectedSport}`
                ) {
                  sBarCountry = selectedCountry;
                  sBarSport = selectedSport;
                }
                drawBarChart(selectedBar);
              })
              .on("mouseover", (event, d) => {
                lineTooltip
                  .style("opacity", 1)
                  .html(
                    `<strong>${s.name}</strong><br>${d.year}: ${d.total} medals`
                  );
              })
              .on("mousemove", (event) => {
                lineTooltip
                  .style("left", event.pageX + 14 + "px")
                  .style("top", event.pageY + 14 + "px");
              })
              .on("mouseout", () => lineTooltip.style("opacity", 0));
          });

          // Add legend
          const legend = gLine
            .append("g")
            .attr("transform", `translate(475, 0)`);

          legend
            .append("text")
            .attr("x", 0)
            .attr("y", 0)
            .text("Click a colored box")
            .style("font-size", "12px")
            .style("font-weight", "bold");

          legend
            .append("text")
            .attr("transform", `translate(0, 12)`)
            .attr("x", 0)
            .attr("y", 0)
            .text("to hide the line")
            .style("font-size", "12px")
            .style("font-weight", "bold");

          series.forEach((s, i) => {
            const row = legend
              .append("g")
              .attr("transform", `translate(0, ${i * 20 + 20})`)
              .style("cursor", "pointer"); // Makes it clear it's clickable

            // Checkbox rectangle
            const checkbox = row
              .append("rect")
              .attr("x", 0)
              .attr("y", 0)
              .attr("width", 12)
              .attr("height", 12)
              .attr("fill", hiddenSeries.has(s.name) ? "white" : s.color)
              .attr("stroke", s.color)
              .attr("stroke-width", 2);

            // Series label
            row
              .append("text")
              .attr("x", 18)
              .attr("y", 10)
              .text(s.name)
              .style("font-size", "12px");

            // Click to toggle visibility
            row.on("click", () => {
              if (hiddenSeries.has(s.name)) {
                hiddenSeries.delete(s.name);
              } else {
                hiddenSeries.add(s.name);
              }
              drawLineChart(); // Redraw chart and legend
            });
          });
        }

        // Initial draw: all countries
        drawLineChart();

        // Update chart when country selected
        countrySelect.on("change", (event) => {
          country = event.target.value;
          if (country == "none") {
            selectedCountry = null;
          } else {
            selectedCountry = event.target.value;
          }
          drawLineChart();
        });

        // Update chart when sport selected
        sportSelect.on("change", (event) => {
          sport = event.target.value;
          if (sport == "none") {
            selectedSport = null;
          } else {
            selectedSport = event.target.value;
          }
          drawLineChart();
        });

        svgMap
          .append("g")
          .selectAll("path")
          .data(mapCountries.features)
          .enter()
          .append("path")
          .attr("fill", "#ddd")
          .attr("stroke", "#888")
          .attr("d", path);

        // Draw Olympic city circles
        svgMap
          .append("g")
          .selectAll("circle")
          .data(cities)
          .enter()
          .append("circle")
          .attr("cx", (d) => projection([d.lon, d.lat])[0])
          .attr("cy", (d) => projection([d.lon, d.lat])[1])
          .attr("r", 6)
          .attr("fill", "steelblue")
          .on("mouseover", (event, d) => {
            mapTooltip
              .style("opacity", 1)
              .html(
                `<strong>${d.city}</strong><br>Years: ${d.years
                  .map(
                    (year) =>
                      `<span class="year" data-year="${year}">${year}</span>`
                  )
                  .join(", ")}`
              );

            mapTooltip.selectAll(".year").on("click", (event) => {
              event.stopPropagation();
              selectedYear = event.target.getAttribute("data-year");
              sBarCountry = null;
              sBarSport = null;
              drawBarChart(selectedBar);
            });
          })
          .on("mousemove", (event) => {
            mapTooltip
              .style("left", event.pageX + 14 + "px")
              .style("top", event.pageY + 14 + "px");
          });

        function createCountryData(data, year, sport, country) {
          const result = [];

          for (const c in data) {
            const entries = data[c];
            bronze_count = 0;
            silver_count = 0;
            gold_count = 0;
            for (const item of entries) {
              const matchYear = !year || item.year == year;
              const matchSport = !sport || item.sport == sport;

              if (matchYear && matchSport) {
                bronze_count += item.bronze;
                gold_count += item.gold;
                silver_count += item.silver;
              }
            }

            medals_count = bronze_count + gold_count + silver_count;
            if (medals_count != 0 && (country == null || c == country)) {
              result.push({
                country: c,
                bronze: bronze_count,
                silver: silver_count,
                gold: gold_count,
              });
            }
          }
          return result;
        }

        function createSportData(data, year, country, sport) {
          const result = [];

          for (const s in data) {
            const entries = data[s];
            bronze_count = 0;
            silver_count = 0;
            gold_count = 0;
            for (const item of entries) {
              const matchYear = !year || item.year == year;
              const matchCountry = !country || item.country == country;

              if (matchYear && matchCountry) {
                bronze_count += item.bronze;
                gold_count += item.gold;
                silver_count += item.silver;
              }
            }

            medals_count = bronze_count + gold_count + silver_count;
            if (medals_count != 0 && (sport == null || s == sport)) {
              result.push({
                sport: s,
                bronze: bronze_count,
                silver: silver_count,
                gold: gold_count,
              });
            }
          }
          return result;
        }

        function createAthleteData(data, year, country, sport) {
          const result = [];

          for (const athlete in data) {
            const entries = data[athlete];
            bronze_count = 0;
            silver_count = 0;
            gold_count = 0;
            for (const item of entries) {
              const matchYear = !year || item.year == year;
              const matchCountry = !country || item.country == country;
              const matchSport = !sport || item.sport == sport;

              if (matchYear && matchCountry && matchSport) {
                bronze_count += item.bronze;
                gold_count += item.gold;
                silver_count += item.silver;
              }
            }

            medals_count = bronze_count + gold_count + silver_count;
            if (medals_count != 0) {
              result.push({
                athlete: athlete,
                bronze: bronze_count,
                silver: silver_count,
                gold: gold_count,
              });
            }
          }
          return result;
        }

        function drawBarChart(type) {
          const parts = [selectedYear, sBarCountry, sBarSport];
          const filtered = parts.filter((p) => p != null && p !== "");
          title = filtered.join(" - ");
          if (title == "") {
            title = "Total";
          }
          titleText = `By ${
            type.charAt(0).toUpperCase() + type.slice(1).toLowerCase()
          } - ${title}`;
          d3.select("#chart-title").text(titleText);
          if (type == "country") {
            data = createCountryData(
              countries,
              selectedYear,
              sBarSport,
              sBarCountry
            );
          } else if (type == "sport") {
            data = createSportData(
              events,
              selectedYear,
              sBarCountry,
              sBarSport
            );
          } else {
            data = createAthleteData(
              athletes,
              selectedYear,
              sBarCountry,
              sBarSport
            );
          }
          let marginL = 60;
          if (type == "sport") {
            marginL = 100;
          }
          if (type == "athlete") {
            marginL = 150;
          }

          // Compute total medals and sort
          data.forEach((d) => {
            d.total = d.bronze + d.silver + d.gold;
          });
          data = data.sort((a, b) => d3.descending(a.total, b.total));

          const barHeight = 15;
          const visibleHeight = 500;
          const neededHeight =
            data.length * barHeight + margin.top + margin.bottom;
          const svgHeight = Math.max(neededHeight, visibleHeight);

          svgChart.attr("height", svgHeight);
          svgChart.selectAll("*").remove();

          // X scale based on total medals
          const x = d3
            .scaleLinear()
            .domain([0, d3.max(data, (d) => d.total)])
            .nice()
            .range([marginL, chartWidth - margin.right]);

          // Y scale is athletes
          const y = d3
            .scaleBand()
            .domain(data.map((d) => d[type]))
            .range([margin.top, neededHeight - margin.bottom])
            .padding(0.2);

          // Axes
          svgChart
            .append("g")
            .attr("transform", `translate(0, ${neededHeight - margin.bottom})`)
            .call(d3.axisBottom(x));

          svgChart
            .append("g")
            .attr("transform", `translate(${marginL}, 0)`)
            .call(d3.axisLeft(y));

          // Colors for each medal type
          const medalColors = {
            bronze: "#9F7A34",
            silver: "#c0c0c0",
            gold: "#D4AF37",
          };

          // Stacked bar drawing
          svgChart
            .append("g")
            .selectAll("g.athlete-bar")
            .data(data)
            .enter()
            .append("g")
            .attr("class", "athlete-bar")
            .attr("transform", (d) => `translate(0, ${y(d[type])})`)
            .each(function (d) {
              let currentX = x(0); // start at 0
              const medalOrder = ["bronze", "silver", "gold"];

              medalOrder.forEach((medal) => {
                const value = d[medal];
                if (value > 0) {
                  const rectWidth = x(value) - x(0);
                  d3.select(this)
                    .append("rect")
                    .attr("x", currentX)
                    .attr("width", rectWidth)
                    .attr("height", y.bandwidth())
                    .attr("fill", medalColors[medal])
                    .on("mouseover", (event) => {
                      barTooltip.style("opacity", 1).html(`
                        <strong>${d[type]}</strong><br>
                        Gold: ${d.gold}<br>
                        Silver: ${d.silver}<br>
                        Bronze: ${d.bronze}<br>
                        Total: ${d.total}
                      `);
                    })
                    .on("mousemove", (event) => {
                      barTooltip
                        .style("left", event.pageX + 14 + "px")
                        .style("top", event.pageY + 14 + "px");
                    })
                    .on("mouseout", () => barTooltip.style("opacity", 0));

                  currentX += rectWidth; // increment X for next medal
                }
              });
            });
        }

        drawBarChart(selectedBar);
      });
    </script>
  </body>
</html>
