<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Olympic Medal Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      .chart-container {
        width: 500px;
        height: 350px;
        overflow-y: auto;
        border: 1px solid #ccc;
      }
      #map-tooltip {
        position: absolute;
        pointer-events: auto;
        background: white;
        padding: 6px 10px;
        border: 1px solid #aaa;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      #line-tooltip {
        position: absolute;
        pointer-events: auto;
        background: white;
        padding: 6px 10px;
        border: 1px solid #aaa;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      #chart-tooltip {
        position: absolute;
        pointer-events: auto;
        background: white;
        padding: 6px 10px;
        border: 1px solid #aaa;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      #left-panel {
        width: 60%;
        border-right: 1px solid #ccc;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
      }
      #right-panel {
        flex-grow: 1;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      .section {
        margin-bottom: 20px;
      }
      .section h3 {
        margin-bottom: 10px;
      }
      .toggle-group button {
        margin-right: 10px;
      }
      #chart-container {
        flex-grow: 1;
        border: 1px solid #ccc;
        margin-top: 10px;
      }
      #chart-line {
        display: none;
      }
      .hidden {
        display: none;
      }
      svg {
        display: block;
        margin: 0 auto;
      }
      .year {
        text-decoration: underline;
        cursor: pointer;
        color: blue;
      }
    </style>
  </head>
  <body>
    <div id="left-panel">
      <div class="section">
        <h3>View Mode</h3>
        <div class="toggle-group">
          <button id="line-view-btn">Line Graph</button>
          <button id="map-view-btn">Map View</button>
        </div>
      </div>

      <div class="section">
        <h3>Filter Options</h3>
        <label>Country:</label>
        <select id="country-select">
          <option value="all">All</option>
        </select>

        <label>Sport:</label>
        <select id="sport-select">
          <option value="all">All</option>
        </select>

        <div id="row-map">
          <div id="chart-map">
            <h2>Summer Olympic Host Cities (1896 - 2012)</h2>
            <div id="map"></div>
            <div id="map-tooltip"></div>
          </div>
          <div id="chart-line">
            <h2 id="chart-line-title">Medals Over Time</h2>
            <svg id="line-chart" width="700" height="400"></svg>
            <div id="line-tooltip"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="right-panel">
      <div class="section">
        <h3>Medal Count</h3>
        <div class="toggle-group">
          <button id="by-country-btn">By Country</button>
          <button id="by-discipline-btn">By Discipline</button>
          <button id="by-athlete-btn">By Athlete</button>
        </div>
      </div>
      <div id="chart">
        <h2 id="chart-title">Total</h2>
        <div class="chart-container">
          <svg id="bar-chart" width="500"></svg>
        </div>
        <div id="chart-tooltip"></div>
      </div>
    </div>
    <script>
      const mapBlock = document.getElementById("chart-map");
      const lineBlock = document.getElementById("chart-line");

      document.getElementById("line-view-btn").addEventListener("click", () => {
        mapBlock.style.display = "none";
        lineBlock.style.display = "block";
      });

      document.getElementById("map-view-btn").addEventListener("click", () => {
        lineBlock.style.display = "none";
        mapBlock.style.display = "block";
      });

      const mapWidth = 700,
        mapHeight = 400;
      const chartWidth = 500;
      const margin = { top: 30, right: 20, bottom: 30, left: 50 };

      const svgMap = d3
        .select("#map")
        .append("svg")
        .attr("width", mapWidth)
        .attr("height", mapHeight);
      const mapTooltip = d3.select("#map-tooltip");
      const svgChart = d3.select("#bar-chart");
      const svgEventChart = d3.select("#event-chart");
      const svgAthleteChart = d3.select("#athlete-chart");
      const lineTooltip = d3.select("#line-tooltip");
      const barTooltip = d3.select("#chart-tooltip");

      const projection = d3
        .geoMercator()
        .scale(120)
        .center([15, 10]) // center longitude, latitude
        .translate([mapWidth / 2, mapHeight / 2]);
      const path = d3.geoPath().projection(projection);

      let selectedYear = null;
      let selectedCountry = null;
      let selectedSport = null;

      Promise.all([
        d3.json(
          "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"
        ),
        d3.json("centroids.json"),
        d3.json("years.json"),
        d3.json("countries.json"),
        d3.json("events.json"),
        d3.json("athletes.json"),
      ]).then(([world, cities, years, countries, events, athletes]) => {
        const mapCountries = topojson.feature(world, world.objects.countries);

        const svgLine = d3.select("#line-chart");
        const svgChart = d3.select("#bar-chart");
        const lineMargin = { top: 30, right: 20, bottom: 40, left: 50 };
        const lineWidth =
          +svgLine.attr("width") - lineMargin.left - lineMargin.right;
        const lineHeight =
          +svgLine.attr("height") - lineMargin.top - lineMargin.bottom;

        const gLine = svgLine
          .append("g")
          .attr("transform", `translate(${lineMargin.left},${lineMargin.top})`);

        const countrySelect = d3.select("#country-select");
        const countryList = Object.keys(countries).sort();
        countryList.forEach((c) =>
          countrySelect.append("option").attr("value", c).text(c)
        );

        const sportSelect = d3.select("#sport-select");
        const sportList = Object.keys(events).sort();
        sportList.forEach((c) =>
          sportSelect.append("option").attr("value", c).text(c)
        );

        function createYearsData(data, country, sport) {
          const result = {};

          for (const year in data) {
            const entries = data[year];
            medal_ct = 0;
            for (const item of entries) {
              const matchCountry = !country || item.country == country;
              const matchSport = !sport || item.sport == sport;

              if (matchCountry && matchSport) {
                medal_ct += item.bronze + item.silver + item.gold;
              }
            }

            if (medal_ct != 0) {
              result[year] = medal_ct;
            }
          }
          return result;
        }

        function drawLineChart() {
          yearTotals = createYearsData(years, selectedCountry, selectedSport);

          const dataLine = Object.entries(yearTotals)
            .map(([year, total]) => ({ year: +year, total }))
            .sort((a, b) => a.year - b.year);

          gLine.selectAll("*").remove();

          // Scales
          const x = d3
            .scaleLinear()
            .domain(d3.extent(dataLine, (d) => d.year))
            .range([0, lineWidth]);

          const y = d3
            .scaleLinear()
            .domain([0, d3.max(dataLine, (d) => d.total)])
            .nice()
            .range([lineHeight, 0]);

          // Axes
          gLine
            .append("g")
            .attr("transform", `translate(0,${lineHeight})`)
            .call(d3.axisBottom(x).tickFormat(d3.format("d")));

          gLine.append("g").call(d3.axisLeft(y));

          // Line
          const line = d3
            .line()
            .x((d) => x(d.year))
            .y((d) => y(d.total));

          gLine
            .append("path")
            .datum(dataLine)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 2)
            .attr("d", line);

          // Points
          gLine
            .selectAll(".dot")
            .data(dataLine)
            .enter()
            .append("circle")
            .attr("cx", (d) => x(d.year))
            .attr("cy", (d) => y(d.total))
            .attr("r", 4)
            .attr("fill", "orange")
            .on("mouseover", (event, d) => {
              lineTooltip
                .style("opacity", 1)
                .html(`<strong>${d.year}</strong>: ${d.total} medals`);
            })
            .on("mousemove", (event) => {
              lineTooltip
                .style("left", event.pageX + 14 + "px")
                .style("top", event.pageY + 14 + "px");
            })
            .on("mouseout", () => lineTooltip.style("opacity", 0));
        }

        // Initial draw: all countries
        drawLineChart();

        // Update chart when country selected
        countrySelect.on("change", (event) => {
          country = event.target.value;
          if (country == "all") {
            selectedCountry = null;
          } else {
            selectedCountry = event.target.value;
          }
          drawLineChart();
          drawBarChart();
        });

        // Update chart when sport selected
        sportSelect.on("change", (event) => {
          sport = event.target.value;
          if (sport == "all") {
            selectedSport = null;
          } else {
            selectedSport = event.target.value;
          }
          drawLineChart();
        });

        svgMap
          .append("g")
          .selectAll("path")
          .data(mapCountries.features)
          .enter()
          .append("path")
          .attr("fill", "#ddd")
          .attr("stroke", "#888")
          .attr("d", path);

        // Draw Olympic city circles
        svgMap
          .append("g")
          .selectAll("circle")
          .data(cities)
          .enter()
          .append("circle")
          .attr("cx", (d) => projection([d.lon, d.lat])[0])
          .attr("cy", (d) => projection([d.lon, d.lat])[1])
          .attr("r", 6)
          .attr("fill", "steelblue")
          .on("mouseover", (event, d) => {
            mapTooltip
              .style("opacity", 1)
              .html(
                `<strong>${d.city}</strong><br>Years: ${d.years
                  .map(
                    (year) =>
                      `<span class="year" data-year="${year}">${year}</span>`
                  )
                  .join(", ")}`
              );

            mapTooltip.selectAll(".year").on("click", (event) => {
              event.stopPropagation();
              selectedYear = event.target.getAttribute("data-year");
            });
          })
          .on("mousemove", (event) => {
            mapTooltip
              .style("left", event.pageX + 14 + "px")
              .style("top", event.pageY + 14 + "px");
          });

        function createCountryData(data, year, sport) {
          const result = [];

          for (const country in data) {
            const entries = data[country];
            bronze_count = 0;
            silver_count = 0;
            gold_count = 0;
            for (const item of entries) {
              const matchYear = !year || item.year == year;
              const matchSport = !sport || item.sport == sport;

              if (matchYear && matchSport) {
                bronze_count += item.bronze;
                gold_count += item.gold;
                silver_count += item.silver;
              }
            }

            medals_count = bronze_count + gold_count + silver_count;
            if (medals_count != 0) {
              result.push({
                country: country,
                bronze: bronze_count,
                silver: silver_count,
                gold: gold_count,
              });
            }
          }
          return result;
        }

        function drawBarChart() {
          const parts = [selectedYear, selectedCountry, selectedSport];
          const filtered = parts.filter((p) => p != null && p !== "");
          titleText = filtered.join(" - ");
          if (titleText == '') {
            titleText = "Total";
          }
          d3.select("#chart-title").text(titleText);
          data = createCountryData(countries, selectedYear, selectedSport);

          // Compute total medals and sort
          data.forEach((d) => {
            d.total = d.bronze + d.silver + d.gold;
          });
          data = data.sort((a, b) => d3.descending(a.total, b.total));

          const barHeight = 15;
          const visibleHeight = 500;
          const neededHeight =
            data.length * barHeight + margin.top + margin.bottom;
          const svgHeight = Math.max(neededHeight, visibleHeight);

          svgChart.attr("height", svgHeight);
          svgChart.selectAll("*").remove();

          // X scale based on total medals
          const x = d3
            .scaleLinear()
            .domain([0, d3.max(data, (d) => d.total)])
            .nice()
            .range([50, chartWidth - margin.right]);

          // Y scale is athletes
          const y = d3
            .scaleBand()
            .domain(data.map((d) => d.country))
            .range([margin.top, neededHeight - margin.bottom])
            .padding(0.2);

          // Axes
          svgChart
            .append("g")
            .attr("transform", `translate(0, ${neededHeight - margin.bottom})`)
            .call(d3.axisBottom(x));

          svgChart
            .append("g")
            .attr("transform", `translate(50, 0)`)
            .call(d3.axisLeft(y));

          // Colors for each medal type
          const medalColors = {
            bronze: "#9F7A34",
            silver: "#c0c0c0",
            gold: "#D4AF37",
          };

          // Stacked bar drawing
          svgChart
            .append("g")
            .selectAll("g.athlete-bar")
            .data(data)
            .enter()
            .append("g")
            .attr("class", "athlete-bar")
            .attr("transform", (d) => `translate(0, ${y(d.country)})`)
            .each(function (d) {
              let currentX = x(0); // start at 0
              const medalOrder = ["bronze", "silver", "gold"];

              medalOrder.forEach((medal) => {
                const value = d[medal];
                if (value > 0) {
                  const rectWidth = x(value) - x(0);
                  d3.select(this)
                    .append("rect")
                    .attr("x", currentX)
                    .attr("width", rectWidth)
                    .attr("height", y.bandwidth())
                    .attr("fill", medalColors[medal])
                    .on("mouseover", (event) => {
                      barTooltip.style("opacity", 1).html(`
                  <strong>${d.country}</strong><br>
                  Gold: ${d.gold}<br>
                  Silver: ${d.silver}<br>
                  Bronze: ${d.bronze}<br>
                  Total: ${d.total}
                `);
                    })
                    .on("mousemove", (event) => {
                      barTooltip
                        .style("left", event.pageX + 14 + "px")
                        .style("top", event.pageY + 14 + "px");
                    })
                    .on("mouseout", () => barTooltip.style("opacity", 0));

                  currentX += rectWidth; // increment X for next medal
                }
              });
            });
        }

        drawBarChart(createCountryData(countries), "Total");
      });
    </script>
  </body>
</html>
